name: Update Repository Catalogue Data

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:  # Allow manual trigger
    inputs:
      organizations:
        description: 'Organizations to fetch (JSON array)'
        required: false
        default: '["azerothcore"]'
      topics:
        description: 'Topics mapping (JSON object)'
        required: false
        default: '{"azerothcore": ["azerothcore-module", "azerothcore-module+ac-premium", "azerothcore-tools", "azerothcore-lua", "azerothcore-sql"]}'
      global-search:
        description: 'Search globally across GitHub (true) or restrict to organizations (false)'
        required: false
        default: 'true'

jobs:
  update-catalogue:
    runs-on: ubuntu-latest
    concurrency:
      group: catalogue-update
      cancel-in-progress: true
    steps:
      - name: Checkout azerothcore.github.io
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history so we can rebase before pushing

      - name: Set default values
        id: defaults
        run: |
          ORGS='${{ github.event.inputs.organizations }}'
          TOPICS='${{ github.event.inputs.topics }}'
          GLOBAL_SEARCH='${{ github.event.inputs.global-search }}'
          
          if [ -z "$ORGS" ]; then
            ORGS='["azerothcore"]'
          fi
          
          if [ -z "$TOPICS" ]; then
            TOPICS='{"azerothcore": ["azerothcore-module", "azerothcore-module+ac-premium", "azerothcore-tools", "azerothcore-lua", "azerothcore-sql"]}'
          fi
          
          if [ -z "$GLOBAL_SEARCH" ]; then
            GLOBAL_SEARCH='true'
          fi
          
          echo "organizations=$ORGS" >> $GITHUB_OUTPUT
          echo "topics=$TOPICS" >> $GITHUB_OUTPUT
          echo "global-search=$GLOBAL_SEARCH" >> $GITHUB_OUTPUT

      - name: Fetch Repository Catalogue Data
        id: fetch-repos
        uses: azerothcore/git-catalogue/.github/actions/fetch-repositories@master
        with:
          organizations: ${{ steps.defaults.outputs.organizations }}
          topics: ${{ steps.defaults.outputs.topics }}
          global-search: ${{ steps.defaults.outputs.global-search }}
          output-path: 'data/catalogue.json'
          per-page: '100'
          max-retries: '3'
          rate-limit-delay: '2'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create data directory if it doesn't exist
        run: mkdir -p data

      - name: Verify generated file
        run: |
          if [ -f "data/catalogue.json" ]; then
            echo "âœ… Catalogue file generated successfully"
            echo "File size: $(du -h data/catalogue.json | cut -f1)"
            echo "Total repositories: ${{ steps.fetch-repos.outputs.total-repos }}"
            
            # Validate JSON structure and content
            if ! jq empty data/catalogue.json; then
              echo "âŒ Generated JSON is invalid"
              exit 1
            fi
            
            # Check if we have any repositories
            repo_count=$(jq '[.organizations[] | to_entries[] | .value | length] | add' data/catalogue.json)
            if [ "$repo_count" -eq 0 ]; then
              echo "âš ï¸  Warning: No repositories found in catalogue"
              echo "This might indicate a configuration issue or lack of repositories with the specified topics"
            fi
          else
            echo "âŒ Catalogue file was not generated"
            exit 1
          fi

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/catalogue.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Update repository catalogue data
            
            - Total repositories: ${{ steps.fetch-repos.outputs.total-repos }}
            - Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            - Organizations: ${{ steps.defaults.outputs.organizations }}
            
            Auto-generated by GitHub Actions"
            git push
            echo "âœ… Catalogue data updated and pushed"
          fi

      - name: Summary
        run: |
          echo "## ðŸ“Š Catalogue Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Repositories:** ${{ steps.fetch-repos.outputs.total-repos }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Organizations:** ${{ steps.defaults.outputs.organizations }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Generated At:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Output File:** \`data/catalogue.json\`" >> $GITHUB_STEP_SUMMARY
